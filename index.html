<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="icon" href="assets/icon.png">
    <link rel="stylesheet" href="style.css">
    <title>RC-controller</title>
</head>

<body>
    <div class="container">
        <div class="header">RC-controller</div>
        <div class="column-left">
            <div class="row1">
                <div class="meter">
                    <span style="text-align: left;">MIN</span>
                    <div id="meter-speed"></div>
                    <span style="text-align: right;">MAX</span>
                </div>
                <div class="meter">
                    <span style="text-align: left;">L</span>
                    <div id="meter-dir"></div>
                    <span style="text-align: right;">R</span>
                </div>
            </div>
            <div class="row2">
                <div>DIRECTION</div>
                <input type="range" min="50" step="1" max="130" value="90" class="slider" id="slider-dir" />
            </div>
            <div class="row3">
                <div class="button" id="btn-handbrake">HANDBRAKE / RESET</div>
                <div class="button" id="btn-reverse">REVERSE</div>
            </div>
        </div>
        <div class="column-right">
            <div>SPEED</div>
            <input type="range" min="590" step="5" max="1023" value="0" class="slider" id="slider-speed" />
        </div>
    </div>
</body>

</html>

<script>

    clientID = "clientID_" + parseInt(Math.random() * 100);
    host = "maqiatto.com"
    port = 8883
    username = "samuel.staflin@abbindustrigymnasium.se"
    password = "Samuel0303"
    topic = "samuel.staflin@abbindustrigymnasium.se/motor";

    var dir = "090"
    var speed = "0000"
    var reverse = "1"
    var connected = false

    // ------- Connect --------------------
    function publish() {
        message = reverse + speed + dir
        console.log("Message: ", message)

        client = new Paho.MQTT.Client(host, Number(port), clientID);

        client.onConnectionLost = onConnectionLost;

        client.connect({
            userName: username, password: password,
            onSuccess: onConnect,
            onFailure: onFail,
        });
    }

    // ------- Status --------------------
    function onFail() {
        connected = false
        console.log("Connecton failed... ")
    }
    function onConnectionLost() {
        connected = false
        console.log("Connecton lost... ")
    }
    function onConnect() {
        connected = true
        message = new Paho.MQTT.Message(message);
        message.destinationName = topic;
        client.send(message);
        console.log("sent")
    }

    // ------- Sätt värde --------------------

    $('#btn-reverse').click(function() {
        if (reverse != "0") {reverse = "0"; $("#btn-reverse").css("background", "#777777")}
        else  {reverse = "1"; $("#btn-reverse").css("background", "#aaaaaa")}     
        publish()
    })

    $('#btn-handbrake').click(function() {
        speed = "0000"
        dir = "090"
        reverse = "1"
        $('#slider-dir').val(90)
        $('#slider-speed').val(0)
        $('#meter-dir').css('transform', 'rotate(0deg)')
        $('#meter-speed').css('transform', 'rotate(270deg)')
        $("#btn-reverse").css("background", "#aaaaaa")
        publish()
    });

    $("#slider-dir").on('input', function () {
        dir = "0".repeat(3 - this.value.length) + this.value
        let deg = (this.value - 90) * 2

        $('#meter-dir').css('transform', 'rotate(' + deg + 'deg)')
    });

    $("#slider-speed").on('input',function () {
        let deg
        if (this.value <= 600) { speed = "0000"; deg = 0 }
        else { speed = "0".repeat(4 - this.value.length) + this.value; deg = (this.value - 590) / 3 }
        deg -= 90

        $('#meter-speed').css('transform', 'rotate(' + deg + 'deg)')
    });

    $('.slider').change(publish);


</script>